apiVersion: v1
kind: Namespace
metadata:
  name: fsi-ray-gpu-quantresearcher
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: efs-shared-ray-gpu-quantresearcher
  namespace: fsi-ray-gpu-quantresearcher
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: efs-fc
  resources:
    requests:
      storage: 100Gi

---
apiVersion: ray.io/v1alpha1
kind: RayCluster
metadata:
  name: fsi-ray-gpu-quantresearcher
  namespace: fsi-ray-gpu-quantresearcher
spec:
  rayVersion: '2.35.0'
  enableInTreeAutoscaling: true
  autoscalerOptions:
    upscalingMode: Default
    idleTimeoutSeconds: 60
    imagePullPolicy: IfNotPresent
    securityContext: { }
    env: [ ]
    envFrom: [ ]
    resources:
      limits:
        gpu: "500m"
        memory: "512Mi"
      requests:
        gpu: "500m"
        memory: "512Mi"
  headGroupSpec:
    rayStartParams:
      dashboard-host: '0.0.0.0'
    template:
      spec:
        volumes:
          - name: efs-shared-ray-gpu-quantresearcher
            persistentVolumeClaim:
              claimName: efs-shared-ray-gpu-quantresearcher
        nodeSelector:
          type: karpenter
          NodeGroupType: g4-gpu-karpenter
        containers:
          - name: ray-head
            image: rayproject/ray-ml:2.35.0.deprecated-py311-gpu
            resources:
              limits:
                gpu: 3
                memory: 14Gi
                nvidia.com/gpu: 1
              requests:
                gpu: 2
                memory: 10Gi
                nvidia.com/gpu: 1
            volumeMounts:
              - name: efs-shared-ray-gpu-quantresearcher
                mountPath: /home/shared
                subPath: shared
              - name: efs-shared-ray-gpu-quantresearcher
                mountPath: /home/quantresearcher
                subPath: home/quantresearcher
            ports:
              - containerPort: 6379
                name: gcs-server
              - containerPort: 8265
                name: dashboard
              - containerPort: 10001
                name: client
  workerGroupSpecs:
    - replicas: 1
      minReplicas: 1
      maxReplicas: 5
      rayStartParams: {}
      groupName: gpu-group
      template:
        spec:
          volumes:
            - name: efs-shared-ray-gpu-quantresearcher
              persistentVolumeClaim:
                claimName: efs-shared-ray-gpu-quantresearcher
          nodeSelector:
            type: karpenter
            NodeGroupType: x86-gpu-karpenter
          containers:
            - name: ray-worker
              image: rayproject/ray-ml:2.35.0.deprecated-py311-gpu
              lifecycle:
                preStop:
                  exec:
                    command: ["/bin/sh","-c","ray stop"]
              volumeMounts:
                - name: efs-shared-ray-gpu-quantresearcher
                  mountPath: /home/shared
                  subPath: shared
                - name: efs-shared-ray-gpu-quantresearcher
                  mountPath: /home/quantresearcher
                  subPath: home/quantresearcher
              resources:
                limits:
                  gpu: 3
                  memory: 14Gi
                  nvidia.com/gpu: 1
                requests:
                  gpu: 2
                  memory: 10Gi
                  nvidia.com/gpu: 1
                  

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: fsi-ray-gpu-dashboard-quantresearcher
  namespace: fsi-ray-gpu-quantresearcher
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: "/$1"
spec:
  ingressClassName: nginx
  rules:
  - http:
      paths:
        - path: /fsi-ray-gpu-quantresearcher-dashboard/dashboard/(.*)
          pathType: ImplementationSpecific
          backend:
            service:
              name: fsi-ray-gpu-quantresearcher-head-svc
              port:
                number: 8265
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-jupyter-access-fsi-ray-gpu-quantresearcher
  namespace: fsi-ray-gpu-quantresearcher
spec:
  podSelector: {}
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name : jupyterhub
          podSelector:
            matchLabels:
              hub.jupyter.org/username : quantresearcher
      ports:
        - protocol: TCP
          port: 6379 # GCS server port
        - protocol: TCP
          port: 8265 # Dashboard port
        - protocol: TCP
          port: 10001 # Client port
  policyTypes:
    - Ingress